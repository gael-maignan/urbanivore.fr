<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <link rel="icon" type="image/x-icon" href="img/logo.png">
    <title>Urbanivore - Partage NOSTR</title>
    <script src="https://ipfs.copylaradio.com/ipfs/QmQLQ5WdCEc7mpKw5rhUujUU1URKweei4Bb4esyVNd9Atx/G1PalPay_fichiers/jquery-3.6.3.min.js"></script>
    <!-- Import nostr-tools -->
    <script src="https://ipfs.copylaradio.com/ipfs/QmXEmaPRUaGcvhuyeG99mHHNyP43nn8GtNeuDok8jdpG4a/nostr.bundle.js"></script>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root {
            --bg-color: #fdfaf3;
            --accent-color: #6b8e23;
            --accent-dark: #4e6c13;
            --text-color: #3e3e3e;
            --font-main: 'Inter', sans-serif;
            --font-alt: 'Lora', serif;
        }

        * {
            box-sizing: border-box;
            scroll-behavior: smooth;
        }

        body {
            margin: 0;
            font-family: var(--font-main);
            background: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            background: linear-gradient(to right, #6b8e23, #4e6c13);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-style: italic;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
        }

        .profile-section {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .profile-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--accent-color);
        }

        .profile-info h3 {
            margin: 0 0 5px 0;
            color: var(--accent-color);
        }

        .profile-info p {
            margin: 0;
            color: #666;
            font-size: 0.9em;
        }

        .wallet-balance {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }

        .balance-item {
            text-align: center;
            flex: 1;
        }

        .balance-label {
            font-size: 0.8em;
            color: #666;
            margin-bottom: 5px;
        }

        .balance-amount {
            font-size: 1.2em;
            font-weight: bold;
        }

        .g1-balance { color: #4CAF50; }
        .zen-balance { color: #2196F3; }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-color);
        }

        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        .location-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .location-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .coord-input {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .coord-input label {
            margin: 0;
            min-width: 30px;
            font-size: 0.9em;
        }

        .coord-input input {
            width: 80px;
            padding: 8px;
            font-size: 0.9em;
        }

        .map-container {
            height: 300px;
            border-radius: 8px;
            margin-top: 15px;
            border: 2px solid #e0e0e0;
        }

        .btn {
            background: var(--accent-color);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: background-color 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            background: var(--accent-dark);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 600;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .spinner {
            display: none;
            width: 40px;
            height: 40px;
            margin: 20px auto;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .tree-form, .recipe-form {
            display: none;
        }

        .form-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .form-toggle .btn {
            flex: 1;
        }

        .form-toggle .btn.active {
            background: var(--accent-dark);
        }

        .image-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .messages-section {
            margin-top: 30px;
        }

        .message-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 0.9em;
            color: #666;
        }

        .message-content {
            margin-bottom: 10px;
        }

        .message-content img {
            max-width: 100%;
            border-radius: 4px;
            margin-top: 10px;
        }

        .message-tags {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .tag {
            background: var(--accent-color);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
        }

        .debug-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 0.8em;
            max-height: 200px;
            overflow-y: auto;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .location-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .coord-input {
                justify-content: center;
            }

            .form-toggle {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üå≥ Urbanivore NOSTR</h1>
            <p>Partagez vos d√©couvertes d'arbres et recettes via le protocole NOSTR</p>
        </div>

        <!-- Profile Section -->
        <div class="card">
            <div class="profile-section">
                <img id="profile-avatar" class="profile-avatar" src="img/logo.png" alt="Profile">
                <div class="profile-info">
                    <h3 id="profile-name">Non connect√©</h3>
                    <p id="profile-nip05">Connectez-vous avec NOSTR</p>
                    <div class="wallet-balance">
                        <div class="balance-item">
                            <div class="balance-label">G1 Balance</div>
                            <div id="g1-balance" class="balance-amount g1-balance">0 G1</div>
                        </div>
                        <div class="balance-item">
                            <div class="balance-label">Zen Balance</div>
                            <div id="zen-balance" class="balance-amount zen-balance">0 ZEN</div>
                        </div>
                    </div>
                </div>
            </div>
            <button id="connectButton" class="btn">üîó Se connecter avec NOSTR</button>
            <button id="refreshNostrButton" class="btn btn-secondary" style="margin-left: 10px;">üîÑ Re-v√©rifier NOSTR</button>
            
            <!-- Section cr√©ation de compte -->
            <div id="account-creation" style="margin-top: 20px; padding: 15px; background-color: #f5f5f5; border-radius: 8px; display: none;">
                <h4>üìù Cr√©er un compte NOSTR</h4>
                <p style="font-size: 0.9em; color: #666;">Pas d'extension NOSTR ? Cr√©ez un compte pour commencer.</p>
                
                <div class="form-group">
                    <label for="email-input">Email :</label>
                    <input type="email" id="email-input" placeholder="votre@email.com" required>
                </div>
                
                <div class="form-group">
                    <label for="salt-input">Identifiant (optionnel) :</label>
                    <input type="text" id="salt-input" placeholder="Laissez vide pour g√©n√©ration automatique">
                </div>
                
                <div class="form-group">
                    <label for="pepper-input">Mot de passe (optionnel) :</label>
                    <input type="password" id="pepper-input" placeholder="Laissez vide pour g√©n√©ration automatique">
                </div>
                
                <button id="createAccountButton" class="btn btn-secondary">üé≤ Cr√©er un compte NOSTR</button>
            </div>
        </div>

        <!-- Form Toggle -->
        <div class="form-toggle">
            <button class="btn active" onclick="showForm('tree')">üå≥ Nouvel arbre</button>
            <button class="btn" onclick="showForm('recipe')">üç≥ Nouvelle recette</button>
        </div>

        <!-- Tree Form -->
        <div id="tree-form" class="card tree-form">
            <h3>üå≥ Ajouter un arbre comestible</h3>
            <form id="treeForm">
                <div class="form-group">
                    <label for="tree-species">Esp√®ce d'arbre *</label>
                    <input type="text" id="tree-species" required placeholder="ex: Prunus domestica (Prunier)">
                </div>

                <div class="form-group">
                    <label for="tree-description">Description</label>
                    <textarea id="tree-description" placeholder="Description de l'arbre, √©tat, accessibilit√©..."></textarea>
                </div>

                <div class="form-group">
                    <label for="tree-season">Saison de r√©colte</label>
                    <select id="tree-season">
                        <option value="">S√©lectionner une saison</option>
                        <option value="printemps">Printemps</option>
                        <option value="ete">√ât√©</option>
                        <option value="automne">Automne</option>
                        <option value="hiver">Hiver</option>
                        <option value="toute-annee">Toute l'ann√©e</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="tree-accessibility">Accessibilit√©</label>
                    <select id="tree-accessibility">
                        <option value="">S√©lectionner</option>
                        <option value="public">Espace public</option>
                        <option value="prive">Propri√©t√© priv√©e</option>
                        <option value="jardin">Jardin partag√©</option>
                        <option value="parc">Parc municipal</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="tree-image">Photo de l'arbre</label>
                    <div class="file-input-wrapper">
                        <button type="button" class="btn btn-secondary">üì∏ Choisir une photo</button>
                        <input type="file" id="tree-image" accept="image/*">
                    </div>
                    <img id="tree-image-preview" class="image-preview" src="#" alt="Preview">
                </div>
            </form>
        </div>

        <!-- Recipe Form -->
        <div id="recipe-form" class="card recipe-form">
            <h3>üç≥ Ajouter une recette</h3>
            <form id="recipeForm">
                <div class="form-group">
                    <label for="recipe-title">Titre de la recette *</label>
                    <input type="text" id="recipe-title" required placeholder="ex: Confiture de prunes">
                </div>

                <div class="form-group">
                    <label for="recipe-ingredients">Ingr√©dients *</label>
                    <textarea id="recipe-ingredients" required placeholder="Liste des ingr√©dients..."></textarea>
                </div>

                <div class="form-group">
                    <label for="recipe-instructions">Instructions *</label>
                    <textarea id="recipe-instructions" required placeholder="√âtapes de pr√©paration..."></textarea>
                </div>

                <div class="form-group">
                    <label for="recipe-difficulty">Difficult√©</label>
                    <select id="recipe-difficulty">
                        <option value="">S√©lectionner</option>
                        <option value="facile">Facile</option>
                        <option value="moyen">Moyen</option>
                        <option value="difficile">Difficile</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="recipe-time">Temps de pr√©paration</label>
                    <input type="text" id="recipe-time" placeholder="ex: 30 minutes">
                </div>

                <div class="form-group">
                    <label for="recipe-image">Photo de la recette</label>
                    <div class="file-input-wrapper">
                        <button type="button" class="btn btn-secondary">üì∏ Choisir une photo</button>
                        <input type="file" id="recipe-image" accept="image/*">
                    </div>
                    <img id="recipe-image-preview" class="image-preview" src="#" alt="Preview">
                </div>
            </form>
        </div>

        <!-- Location Section -->
        <div class="card">
            <h3>üìç Localisation</h3>
            <div class="location-section">
                <div class="location-controls">
                    <div class="coord-input">
                        <label>Latitude:</label>
                        <input type="number" id="latitude" step="0.000001" min="-90" max="90" placeholder="48.8566">
                    </div>
                    <div class="coord-input">
                        <label>Longitude:</label>
                        <input type="number" id="longitude" step="0.000001" min="-180" max="180" placeholder="2.3522">
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="getCurrentLocation()">üìç Ma position</button>
                    <button type="button" class="btn btn-secondary" onclick="toggleMap()">üó∫Ô∏è Carte</button>
                </div>
                <div id="map-container" class="map-container" style="display: none;"></div>
            </div>
        </div>

        <!-- Post Button -->
        <div class="card">
            <button id="postButton" class="btn btn-success" disabled>üì§ Publier sur NOSTR</button>
            <div class="spinner" id="loadingSpinner"></div>
            <div id="status" class="status info">Pr√™t √† publier vos d√©couvertes urbaines</div>
            
            <!-- Test uSPOT API -->
            <div style="margin-top: 15px; padding: 10px; background-color: #e8f5e8; border-radius: 5px; border: 1px solid #4CAF50;">
                <h4 style="margin: 0 0 10px 0; color: #2e7d32;">üîß Test API uSPOT</h4>
                <p style="font-size: 0.9em; color: #666; margin: 0 0 10px 0;">
                    API d√©tect√©e: <strong id="uspot-url-display"></strong>
                </p>
                <button id="testUSPOTButton" class="btn btn-secondary" style="font-size: 0.9em;">üß™ Tester la connexion uSPOT</button>
                <button id="testNostrAuthButton" class="btn btn-secondary" style="font-size: 0.9em; margin-left: 10px;">üîê Tester auth NOSTR</button>
            </div>
        </div>

        <!-- Messages Section -->
        <div class="messages-section">
            <h3>üìù Messages r√©cents</h3>
            <button class="btn btn-secondary" onclick="refreshMessages()">üîÑ Actualiser</button>
            <div id="messages-container"></div>
        </div>

        <!-- Debug Section -->
        <details>
            <summary>üêõ Debug & Relais</summary>
            <div class="debug-section">
                <div style="margin-bottom: 15px; padding: 10px; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px;">
                    <h4 style="margin: 0 0 10px 0; color: #856404;">üîß Diagnostic NOSTR</h4>
                    <div id="nostr-diagnostic">
                        <p><strong>√âtat de l'extension:</strong> <span id="nostr-status">V√©rification...</span></p>
                        <p><strong>M√©thodes disponibles:</strong> <span id="nostr-methods">V√©rification...</span></p>
                        <p><strong>Derni√®re v√©rification:</strong> <span id="nostr-last-check">-</span></p>
                    </div>
                </div>
                <div id="debug-info"></div>
            </div>
        </details>
    </div>

    <script>
        // Configuration
        const DEFAULT_RELAYS = [
            'wss://relay.copylaradio.com',
            'ws://127.0.0.1:7777',
            'wss://relay.damus.io',
            'wss://nos.lol'
        ];

        // Variables globales
        let publicKey = '';
        let privateKeyHex = null;
        let userProfile = null;
        let pool = null;
        let selectedImageDataUrl = null;
        let currentLatitude = null;
        let currentLongitude = null;
        let map = null;
        let marker = null;
        let currentForm = 'tree';
        
        // Configuration uSPOT API
        let upassportUrl = '';
        let isNostrConnected = false;

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
        });

        function initializeApp() {
            log('üöÄ Initialisation Urbanivore NOSTR...');
            updateStatus('Pr√™t √† se connecter avec NOSTR', 'info');
            detectUSPOTAPI();
            
            // D√©lai initial pour permettre √† l'extension de se charger
            setTimeout(() => {
                checkNostrExtension();
            }, 1000);
            
            // V√©rification p√©riodique de l'extension NOSTR (toutes les 3 secondes pendant 30 secondes)
            let checkCount = 0;
            const maxChecks = 10;
            const checkInterval = setInterval(() => {
                checkCount++;
                log(`üîÑ V√©rification automatique NOSTR (${checkCount}/${maxChecks})...`);
                
                if (typeof window.nostr !== 'undefined' && typeof window.nostr.getPublicKey === 'function') {
                    log('‚úÖ Extension NOSTR d√©tect√©e lors de la v√©rification automatique');
                    clearInterval(checkInterval);
                    checkNostrExtension();
                } else if (checkCount >= maxChecks) {
                    log('‚è∞ V√©rification automatique termin√©e - Extension NOSTR non d√©tect√©e');
                    clearInterval(checkInterval);
                }
            }, 3000);
        }
        
        // D√©tection de l'API uSPOT
        function detectUSPOTAPI() {
            const currentURL = new URL(window.location.href);
            const hostname = currentURL.hostname;
            const port = currentURL.port;
            const protocol = currentURL.protocol.split(":")[0];
            
            // Transformation uSPOT (ipfs. ‚Üí u. et :8080 ‚Üí :54321)
            let upassportPort = port;
            if (port === "8080") {
                upassportPort = "54321";
            }
            const uHost = hostname.replace("ipfs", "u");
            upassportUrl = protocol + "://" + uHost + (upassportPort ? (":" + upassportPort) : "");
            
            log(`API uSPOT d√©tect√©e: ${upassportUrl}`);
            log(`Gateway IPFS: ${hostname}:${port}`);
            
            // Mettre √† jour l'affichage dans l'interface
            const urlDisplay = document.getElementById('uspot-url-display');
            if (urlDisplay) {
                urlDisplay.textContent = upassportUrl;
            }
        }

        function setupEventListeners() {
            // Boutons de connexion et publication
            document.getElementById('connectButton').addEventListener('click', connectToNostr);
            document.getElementById('refreshNostrButton').addEventListener('click', async () => {
                log('üîÑ Re-v√©rification manuelle de NOSTR...');
                updateStatus('Re-v√©rification de NOSTR...', 'info');
                
                // Ajouter un d√©lai pour garantir une meilleure connexion
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                checkNostrExtension();
                updateStatus('Re-v√©rification termin√©e', 'info');
            });
            document.getElementById('postButton').addEventListener('click', postNostrEvent);
            document.getElementById('createAccountButton').addEventListener('click', handleCreateAccount);
            document.getElementById('testUSPOTButton').addEventListener('click', testUSPOTConnection);
            document.getElementById('testNostrAuthButton').addEventListener('click', testNostrAuth);

            // Gestion des images
            document.getElementById('tree-image').addEventListener('change', handleImageSelection);
            document.getElementById('recipe-image').addEventListener('change', handleImageSelection);

            // Gestion de la g√©olocalisation
            document.getElementById('latitude').addEventListener('change', updateCoordinates);
            document.getElementById('longitude').addEventListener('change', updateCoordinates);
        }
        
        // Test de connexion uSPOT
        async function testUSPOTConnection() {
            const button = document.getElementById('testUSPOTButton');
            const originalText = button.textContent;
            
            button.textContent = 'üß™ Test en cours...';
            button.disabled = true;
            
            try {
                log('Test de connexion uSPOT...');
                
                // Test de l'endpoint de sant√©
                const response = await fetch(`${upassportUrl}/health`);
                
                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ uSPOT connect√©: ${JSON.stringify(data)}`);
                    updateStatus('‚úÖ API uSPOT accessible', 'success');
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                log(`‚ùå Erreur connexion uSPOT: ${error.message}`);
                updateStatus(`‚ùå Erreur uSPOT: ${error.message}`, 'error');
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        }
        
        // Test d'authentification NOSTR
        async function testNostrAuth() {
            const button = document.getElementById('testNostrAuthButton');
            const originalText = button.textContent;
            
            button.textContent = 'üîê Test en cours...';
            button.disabled = true;
            
            try {
                if (!publicKey) {
                    throw new Error('Non connect√© √† NOSTR - Connectez-vous d\'abord');
                }
                
                log('Test d\'authentification NOSTR...');
                log(`Cl√© publique: ${publicKey}`);
                
                // Utiliser la route correcte /api/test-nostr avec FormData
                const formData = new FormData();
                formData.append('npub', publicKey);
                
                const response = await fetch(`${upassportUrl}/api/test-nostr`, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ Test NOSTR r√©ussi: ${JSON.stringify(data, null, 2)}`);
                    
                    let statusMessage = 'Test NOSTR termin√©';
                    let statusType = 'info';
                    
                    if (data.status === 'success') {
                        statusMessage = '‚úÖ Authentification NOSTR r√©ussie';
                        statusType = 'success';
                    } else if (data.status === 'partial') {
                        statusMessage = '‚ö†Ô∏è Connexion OK mais auth incompl√®te';
                        statusType = 'warning';
                    } else {
                        statusMessage = '‚ùå √âchec de l\'authentification NOSTR';
                        statusType = 'error';
                    }
                    
                    updateStatus(statusMessage, statusType);
                    
                    // Afficher les recommandations si disponibles
                    if (data.recommendations && data.recommendations.length > 0) {
                        log('üìã Recommandations:');
                        data.recommendations.forEach(rec => log(`  - ${rec}`));
                    }
                    
                } else {
                    let errorMessage = `HTTP ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.detail || errorData.message || errorMessage;
                    } catch (e) {
                        // Si on ne peut pas parser le JSON, utiliser le texte brut
                        const errorText = await response.text();
                        errorMessage = errorText || errorMessage;
                    }
                    throw new Error(errorMessage);
                }
            } catch (error) {
                log(`‚ùå Erreur test NOSTR: ${error.message}`);
                updateStatus(`‚ùå Erreur test NOSTR: ${error.message}`, 'error');
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        }
        
        // Gestion de la cr√©ation de compte
        async function handleCreateAccount() {
            const email = document.getElementById('email-input').value.trim();
            const salt = document.getElementById('salt-input').value.trim();
            const pepper = document.getElementById('pepper-input').value.trim();
            
            if (!email) {
                updateStatus('Veuillez saisir un email', 'error');
                return;
            }
            
            await createNostrAccount(email, salt, pepper);
        }

        // Fonctions utilitaires
        function log(message) {
            console.log(message);
            const debugInfo = document.getElementById('debug-info');
            const timestamp = new Date().toLocaleTimeString();
            debugInfo.innerHTML += `[${timestamp}] ${message}\n`;
            debugInfo.scrollTop = debugInfo.scrollHeight;
        }

        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            log(`Status: ${message}`);
        }

        function showLoading(show) {
            document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
            document.getElementById('postButton').disabled = show || !publicKey;
        }
        
        // Fonction pour cr√©er un compte NOSTR via l'API g1nostr
        async function createNostrAccount(email, salt = '', pepper = '') {
            log(`Cr√©ation du compte NOSTR pour: ${email}`);
            updateStatus('Cr√©ation du compte NOSTR...', 'info');
            
            try {
                const formData = new FormData();
                formData.append('email', email);
                formData.append('lang', navigator.language.split('-')[0] || 'fr');
                formData.append('lat', currentLatitude?.toFixed(6) || '0.00');
                formData.append('lon', currentLongitude?.toFixed(6) || '0.00');
                if (salt) formData.append('salt', salt);
                if (pepper) formData.append('pepper', pepper);
                
                const response = await fetch(`${upassportUrl}/g1nostr`, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);
                    
                    // Ouvrir le r√©sultat dans une nouvelle fen√™tre
                    const newWindow = window.open(url, '_blank');
                    if (newWindow) {
                        log('Compte NOSTR cr√©√© avec succ√®s');
                        updateStatus('Compte NOSTR cr√©√© ! V√©rifiez votre email.', 'success');
                        
                        // Attendre un peu puis essayer de se connecter
                        setTimeout(() => {
                            checkNostrExtension();
                        }, 2000);
                    } else {
                        log('Impossible d\'ouvrir la fen√™tre de r√©sultat');
                        updateStatus('Compte cr√©√© mais impossible d\'afficher le r√©sultat', 'warning');
                    }
                } else {
                    const errorText = await response.text();
                    log(`Erreur cr√©ation compte: ${errorText}`);
                    updateStatus(`Erreur cr√©ation compte: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`Erreur cr√©ation compte: ${error.message}`);
                updateStatus(`Erreur cr√©ation compte: ${error.message}`, 'error');
            }
        }
        
        // Fonction pour upload via l'API uSPOT avec authentification NIP-42
        async function uploadToUSPOT(file, npub) {
            log(`Upload vers uSPOT: ${file.name}`);
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('npub', npub);
                
                const response = await fetch(`${upassportUrl}/api/upload`, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    log(`Upload r√©ussi: ${result.file_path}`);
                    return result;
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `HTTP ${response.status}`);
                }
            } catch (error) {
                log(`Erreur upload uSPOT: ${error.message}`);
                throw error;
            }
        }

        // Gestion des formulaires
        function showForm(formType) {
            currentForm = formType;
            
            // Mettre √† jour les boutons
            document.querySelectorAll('.form-toggle .btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Afficher le bon formulaire
            document.getElementById('tree-form').style.display = formType === 'tree' ? 'block' : 'none';
            document.getElementById('recipe-form').style.display = formType === 'recipe' ? 'block' : 'none';
        }

        // Gestion des images
        function handleImageSelection(event) {
            const file = event.target.files[0];
            if (file) {
                log(`Image s√©lectionn√©e: ${file.name} (${file.size} bytes)`);
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    selectedImageDataUrl = e.target.result;
                    const previewId = event.target.id === 'tree-image' ? 'tree-image-preview' : 'recipe-image-preview';
                    const preview = document.getElementById(previewId);
                    preview.src = selectedImageDataUrl;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        // G√©olocalisation
        function getCurrentLocation() {
            if (navigator.geolocation) {
                updateStatus('R√©cup√©ration de la position...', 'info');
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        currentLatitude = position.coords.latitude;
                        currentLongitude = position.coords.longitude;
                        
                        document.getElementById('latitude').value = currentLatitude.toFixed(6);
                        document.getElementById('longitude').value = currentLongitude.toFixed(6);
                        
                        updateStatus(`Position r√©cup√©r√©e: ${currentLatitude.toFixed(4)}, ${currentLongitude.toFixed(4)}`, 'success');
                        
                        if (map) {
                            map.setView([currentLatitude, currentLongitude], 15);
                            marker.setLatLng([currentLatitude, currentLongitude]);
                        }
                    },
                    function(error) {
                        updateStatus(`Erreur de g√©olocalisation: ${error.message}`, 'error');
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
                );
            } else {
                updateStatus('G√©olocalisation non support√©e par ce navigateur', 'error');
            }
        }

        function updateCoordinates() {
            currentLatitude = parseFloat(document.getElementById('latitude').value);
            currentLongitude = parseFloat(document.getElementById('longitude').value);
            
            if (map && !isNaN(currentLatitude) && !isNaN(currentLongitude)) {
                map.setView([currentLatitude, currentLongitude], map.getZoom());
                marker.setLatLng([currentLatitude, currentLongitude]);
            }
        }

        function toggleMap() {
            const mapContainer = document.getElementById('map-container');
            const isVisible = mapContainer.style.display !== 'none';
            
            if (isVisible) {
                mapContainer.style.display = 'none';
                if (map) {
                    map.remove();
                    map = null;
                    marker = null;
                }
            } else {
                mapContainer.style.display = 'block';
                initializeMap();
            }
        }

        function initializeMap() {
            const lat = currentLatitude || 48.8566;
            const lon = currentLongitude || 2.3522;
            
            map = L.map('map-container').setView([lat, lon], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
            
            marker = L.marker([lat, lon], { draggable: true }).addTo(map);
            
            marker.on('dragend', function(e) {
                const pos = e.target.getLatLng();
                currentLatitude = pos.lat;
                currentLongitude = pos.lng;
                document.getElementById('latitude').value = pos.lat.toFixed(6);
                document.getElementById('longitude').value = pos.lng.toFixed(6);
            });
            
            map.on('click', function(e) {
                const pos = e.latlng;
                currentLatitude = pos.lat;
                currentLongitude = pos.lng;
                document.getElementById('latitude').value = pos.lat.toFixed(6);
                document.getElementById('longitude').value = pos.lng.toFixed(6);
                marker.setLatLng(pos);
            });
        }

        // NOSTR Functions
        function checkNostrExtension() {
            log('üîç V√©rification de l\'extension NOSTR...');
            
            // V√©rifier plusieurs fa√ßons de d√©tecter l'extension
            const nostrAvailable = typeof window.nostr !== 'undefined';
            const nostrGetPublicKey = nostrAvailable && typeof window.nostr.getPublicKey === 'function';
            const nostrSignEvent = nostrAvailable && typeof window.nostr.signEvent === 'function';
            
            log(`window.nostr disponible: ${nostrAvailable}`);
            log(`getPublicKey disponible: ${nostrGetPublicKey}`);
            log(`signEvent disponible: ${nostrSignEvent}`);
            
            // Mettre √† jour le diagnostic
            updateNostrDiagnostic(nostrAvailable, nostrGetPublicKey, nostrSignEvent);
            
            if (nostrAvailable && nostrGetPublicKey && nostrSignEvent) {
                log('‚úÖ Extension NOSTR compl√®tement d√©tect√©e');
                document.getElementById('connectButton').disabled = false;
                updateStatus('Extension NOSTR pr√™te', 'success');
                document.getElementById('account-creation').style.display = 'none';
            } else {
                log('‚ùå Extension NOSTR non trouv√©e ou incompl√®te');
                log('D√©tails:');
                log(`  - window.nostr: ${typeof window.nostr}`);
                if (nostrAvailable) {
                    log(`  - M√©thodes disponibles: ${Object.keys(window.nostr).join(', ')}`);
                }
                
                document.getElementById('connectButton').disabled = true;
                updateStatus('Extension NOSTR requise (Alby, nos2x, etc.) ou cr√©ez un compte', 'warning');
                document.getElementById('account-creation').style.display = 'block';
                
                // Ajouter des instructions de d√©bogage
                addNostrDebugInfo();
            }
        }
        
        // Mettre √† jour le diagnostic NOSTR
        function updateNostrDiagnostic(available, getPublicKey, signEvent) {
            const statusEl = document.getElementById('nostr-status');
            const methodsEl = document.getElementById('nostr-methods');
            const lastCheckEl = document.getElementById('nostr-last-check');
            
            if (statusEl) {
                if (available && getPublicKey && signEvent) {
                    statusEl.textContent = '‚úÖ Compl√®te';
                    statusEl.style.color = '#28a745';
                } else if (available) {
                    statusEl.textContent = '‚ö†Ô∏è Partielle';
                    statusEl.style.color = '#ffc107';
                } else {
                    statusEl.textContent = '‚ùå Non disponible';
                    statusEl.style.color = '#dc3545';
                }
            }
            
            if (methodsEl) {
                if (available) {
                    const methods = Object.keys(window.nostr);
                    methodsEl.textContent = methods.join(', ') || 'Aucune';
                } else {
                    methodsEl.textContent = 'Non disponible';
                }
            }
            
            if (lastCheckEl) {
                lastCheckEl.textContent = new Date().toLocaleTimeString();
            }
        }
        
        // Ajouter des informations de d√©bogage pour NOSTR
        function addNostrDebugInfo() {
            const debugSection = document.getElementById('debug-info');
            if (debugSection) {
                debugSection.innerHTML += `
=== D√âBOGAGE NOSTR ===
1. V√©rifiez que l'extension NOSTR est install√©e et activ√©e
2. Extensions recommand√©es:
   - Alby (Chrome/Firefox)
   - nos2x (Chrome)
   - Amethyst (Android)
3. Assurez-vous que l'extension a les permissions pour ce site
4. Essayez de recharger la page apr√®s avoir activ√© l'extension
5. V√©rifiez la console du navigateur pour les erreurs

√âtat actuel:
- window.nostr: ${typeof window.nostr}
- M√©thodes disponibles: ${typeof window.nostr !== 'undefined' ? Object.keys(window.nostr).join(', ') : 'Aucune'}

==================
`;
            }
        }

        async function connectToNostr() {
            log('üîó Tentative de connexion NOSTR...');
            
            if (typeof window.nostr === 'undefined') {
                log('‚ùå window.nostr non disponible');
                updateStatus('Extension NOSTR non disponible - Re-v√©rifiez l\'extension', 'error');
                return;
            }
            
            if (typeof window.nostr.getPublicKey !== 'function') {
                log('‚ùå getPublicKey non disponible');
                updateStatus('Extension NOSTR incompl√®te - Rechargez la page', 'error');
                return;
            }
            
            try {
                showLoading(true);
                updateStatus('Connexion √† NOSTR...', 'info');
                
                log('üì° Demande de cl√© publique...');
                publicKey = await window.nostr.getPublicKey();
                
                if (!publicKey || publicKey.length < 10) {
                    throw new Error('Cl√© publique invalide re√ßue');
                }
                
                log(`‚úÖ Connect√© avec la cl√©: ${publicKey.slice(0, 10)}...`);
                log(`üìè Longueur de la cl√©: ${publicKey.length} caract√®res`);
                
                document.getElementById('connectButton').style.display = 'none';
                document.getElementById('refreshNostrButton').style.display = 'none';
                document.getElementById('postButton').disabled = false;
                
                updateStatus(`Connexion r√©ussie: ${publicKey.slice(0, 10)}...`, 'success');
                
                // R√©cup√©rer le profil et les messages
                log('üë§ R√©cup√©ration du profil...');
                await fetchProfileAndRelays(publicKey);
                
                log('üìù R√©cup√©ration des messages...');
                await refreshMessages();
                
                // Tester l'authentification NOSTR avec l'API uSPOT
                log('üîê Test d\'authentification NOSTR avec uSPOT...');
                try {
                    await testNostrAuth();
                } catch (error) {
                    log(`‚ö†Ô∏è Test d'authentification √©chou√©: ${error.message}`);
                    // Ne pas bloquer la connexion si le test √©choue
                }
                
                updateStatus(`Connect√©: ${publicKey.slice(0, 10)}...`, 'success');
                
            } catch (error) {
                log(`‚ùå Erreur de connexion: ${error.message}`);
                log(`üìã D√©tails de l'erreur:`, error);
                
                let errorMessage = 'Erreur de connexion';
                if (error.message.includes('User rejected')) {
                    errorMessage = 'Connexion refus√©e par l\'utilisateur';
                } else if (error.message.includes('timeout')) {
                    errorMessage = 'D√©lai d\'attente d√©pass√©';
                } else if (error.message.includes('permission')) {
                    errorMessage = 'Permission refus√©e par l\'extension';
                } else {
                    errorMessage = error.message;
                }
                
                updateStatus(`Erreur: ${errorMessage}`, 'error');
                
                // R√©afficher les boutons en cas d'erreur
                document.getElementById('connectButton').style.display = 'inline-block';
                document.getElementById('refreshNostrButton').style.display = 'inline-block';
            } finally {
                showLoading(false);
            }
        }

        async function fetchProfileAndRelays(pubkey) {
            try {
                log('R√©cup√©ration du profil...');
                
                // Initialiser le pool NOSTR
                if (!pool) {
                    pool = new NostrTools.SimplePool();
                }
                
                // R√©cup√©rer le profil
                const profileEvents = await pool.list(DEFAULT_RELAYS, [
                    { kinds: [0], authors: [pubkey], limit: 1 }
                ]);
                
                if (profileEvents.length > 0) {
                    const profileEvent = profileEvents[0];
                    try {
                        userProfile = JSON.parse(profileEvent.content);
                        renderProfile(pubkey, userProfile);
                        
                        // V√©rifier les soldes si des adresses G1 sont pr√©sentes
                        if (userProfile.g1_address || userProfile.g1_address_v2) {
                            log('üîç Adresses G1 d√©tect√©es dans le profil, v√©rification des soldes...');
                            await checkG1Balances(userProfile);
                        } else {
                            log('‚ÑπÔ∏è Aucune adresse G1 trouv√©e dans le profil');
                            document.getElementById('g1-balance').textContent = '0 G1';
                            document.getElementById('zen-balance').textContent = '0 ZEN';
                        }
                    } catch (e) {
                        log(`Erreur parsing profil: ${e.message}`);
                        userProfile = {};
                        document.getElementById('g1-balance').textContent = '0 G1';
                        document.getElementById('zen-balance').textContent = '0 ZEN';
                    }
                } else {
                    log('‚ÑπÔ∏è Aucun profil trouv√©');
                    userProfile = {};
                    document.getElementById('g1-balance').textContent = '0 G1';
                    document.getElementById('zen-balance').textContent = '0 ZEN';
                }
                
            } catch (error) {
                log(`Erreur r√©cup√©ration profil: ${error.message}`);
                document.getElementById('g1-balance').textContent = 'Erreur';
                document.getElementById('zen-balance').textContent = 'Erreur';
            }
        }

        function renderProfile(pubkey, profileData) {
            const avatar = document.getElementById('profile-avatar');
            const name = document.getElementById('profile-name');
            const nip05 = document.getElementById('profile-nip05');
            
            avatar.src = profileData.picture || 'img/logo.png';
            name.textContent = profileData.display_name || profileData.name || pubkey.slice(0, 16);
            nip05.textContent = profileData.nip05 || pubkey.slice(0, 10) + '...';
        }

        async function checkG1Balances(profileData) {
            try {
                let g1Balance = 0;
                log('üí∞ V√©rification des soldes G1/ZEN...');
                
                if (profileData.g1_address) {
                    log(`Cl√© G1 d√©tect√©e: ${profileData.g1_address}`);
                    const response = await fetch(`${upassportUrl}/check_balance?g1pub=${profileData.g1_address}`);
                    if (response.ok) {
                        const data = await response.json();
                        const balance = parseFloat(data.balance) || 0;
                        document.getElementById('g1-balance').textContent = `${balance} G1`;
                        g1Balance = balance;
                        log(`Solde G1: ${balance} G1`);
                    } else {
                        log(`Erreur r√©cup√©ration solde G1: ${response.status}`);
                    }
                }
                
                if (profileData.g1_address_v2 && !profileData.g1_address) {
                    log(`Cl√© G1 v2 d√©tect√©e: ${profileData.g1_address_v2}`);
                    const response = await fetch(`${upassportUrl}/check_balance?g1pub=${profileData.g1_address_v2}`);
                    if (response.ok) {
                        const data = await response.json();
                        const balance = parseFloat(data.balance) || 0;
                        document.getElementById('g1-balance').textContent = `${balance} G1`;
                        g1Balance = balance;
                        log(`Solde G1 v2: ${balance} G1`);
                    } else {
                        log(`Erreur r√©cup√©ration solde G1 v2: ${response.status}`);
                    }
                }
                
                // Calculer le solde ZEN
                const zenBalance = Math.max(0, Math.floor((g1Balance - 1) * 10));
                document.getElementById('zen-balance').textContent = `${zenBalance} ZEN`;
                log(`Solde ZEN calcul√©: ${zenBalance} ZEN`);
                
                if (g1Balance === 0 && zenBalance === 0) {
                    log('‚ö†Ô∏è Aucun solde G1/ZEN trouv√©');
                    document.getElementById('g1-balance').textContent = '0 G1';
                    document.getElementById('zen-balance').textContent = '0 ZEN';
                }
                
            } catch (error) {
                log(`‚ùå Erreur v√©rification soldes: ${error.message}`);
                document.getElementById('g1-balance').textContent = 'Erreur';
                document.getElementById('zen-balance').textContent = 'Erreur';
            }
        }

        async function postNostrEvent() {
            if (!publicKey) {
                updateStatus('Non connect√© √† NOSTR', 'error');
                return;
            }
            
            const lat = parseFloat(document.getElementById('latitude').value);
            const lon = parseFloat(document.getElementById('longitude').value);
            
            if (isNaN(lat) || isNaN(lon)) {
                updateStatus('Veuillez d√©finir une localisation', 'error');
                return;
            }
            
            showLoading(true);
            updateStatus('Pr√©paration de l\'√©v√©nement...', 'info');
            
            try {
                let content = '';
                let tags = [
                    ['application', 'Urbanivore'],
                    ['latitude', lat.toFixed(6)],
                    ['longitude', lon.toFixed(6)],
                    ['g', `${lat.toFixed(6)};${lon.toFixed(6)}`]
                ];
                
                if (currentForm === 'tree') {
                    const species = document.getElementById('tree-species').value;
                    const description = document.getElementById('tree-description').value;
                    const season = document.getElementById('tree-season').value;
                    const accessibility = document.getElementById('tree-accessibility').value;
                    
                    if (!species) {
                        updateStatus('Veuillez sp√©cifier l\'esp√®ce d\'arbre', 'error');
                        return;
                    }
                    
                    content = `üå≥ ${species}`;
                    if (description) content += `\n\n${description}`;
                    
                    tags.push(['type', 'tree']);
                    tags.push(['species', species]);
                    if (season) tags.push(['season', season]);
                    if (accessibility) tags.push(['accessibility', accessibility]);
                    
                } else if (currentForm === 'recipe') {
                    const title = document.getElementById('recipe-title').value;
                    const ingredients = document.getElementById('recipe-ingredients').value;
                    const instructions = document.getElementById('recipe-instructions').value;
                    const difficulty = document.getElementById('recipe-difficulty').value;
                    const time = document.getElementById('recipe-time').value;
                    
                    if (!title || !ingredients || !instructions) {
                        updateStatus('Veuillez remplir tous les champs obligatoires', 'error');
                        return;
                    }
                    
                    content = `üç≥ ${title}\n\nIngr√©dients:\n${ingredients}\n\nInstructions:\n${instructions}`;
                    if (time) content += `\n\nTemps: ${time}`;
                    
                    tags.push(['type', 'recipe']);
                    tags.push(['title', title]);
                    if (difficulty) tags.push(['difficulty', difficulty]);
                    if (time) tags.push(['time', time]);
                }
                
                // Upload image si pr√©sente
                if (selectedImageDataUrl) {
                    updateStatus('Upload de l\'image vers uSPOT...', 'info');
                    try {
                        const uploadResult = await uploadImageToUSPOT(selectedImageDataUrl);
                        content += `\n\n${uploadResult.uploadedFileURL}`;
                        if (uploadResult.nip94Tags) {
                            tags = tags.concat(uploadResult.nip94Tags.filter(t => Array.isArray(t) && t.length >= 2));
                        }
                        updateStatus('Image upload√©e vers uSPOT avec succ√®s', 'success');
                    } catch (e) {
                        updateStatus(`Erreur upload image uSPOT: ${e}. Publication sans image.`, 'error');
                    }
                }
                
                // Cr√©er l'√©v√©nement
                const event = {
                    kind: 1,
                    pubkey: publicKey,
                    created_at: Math.floor(Date.now() / 1000),
                    tags: tags,
                    content: content
                };
                
                log('√âv√©nement cr√©√©, signature...');
                updateStatus('Signature de l\'√©v√©nement...', 'info');
                
                // Signer l'√©v√©nement
                const signedEvent = await window.nostr.signEvent(event);
                
                log('√âv√©nement sign√©, publication...');
                updateStatus('Publication sur les relais...', 'info');
                
                // Publier sur les relais
                if (!pool) {
                    pool = new NostrTools.SimplePool();
                }
                
                const relays = await pool.publish(signedEvent, DEFAULT_RELAYS);
                const successCount = relays.filter(r => r.status === 1).length;
                
                if (successCount > 0) {
                    updateStatus(`Publi√© sur ${successCount}/${DEFAULT_RELAYS.length} relais!`, 'success');
                    
                    // R√©initialiser le formulaire
                    resetForm();
                    
                    // Actualiser les messages
                    setTimeout(() => refreshMessages(), 2000);
                } else {
                    updateStatus('Erreur lors de la publication', 'error');
                }
                
            } catch (error) {
                log(`Erreur publication: ${error.message}`);
                updateStatus(`Erreur: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        function resetForm() {
            // R√©initialiser les formulaires
            document.getElementById('treeForm').reset();
            document.getElementById('recipeForm').reset();
            
            // R√©initialiser les images
            selectedImageDataUrl = null;
            document.getElementById('tree-image-preview').style.display = 'none';
            document.getElementById('recipe-image-preview').style.display = 'none';
            
            // R√©initialiser les fichiers
            document.getElementById('tree-image').value = '';
            document.getElementById('recipe-image').value = '';
        }

        async function uploadImageToUSPOT(imageDataBase64) {
            return new Promise(async (resolve, reject) => {
                try {
                    const base64Data = imageDataBase64.split(',')[1];
                    const mimeType = imageDataBase64.split(',')[0].split(':')[1].split(';')[0];
                    
                    const binaryData = atob(base64Data);
                    const arrayBuffer = new ArrayBuffer(binaryData.length);
                    const uint8Array = new Uint8Array(arrayBuffer);
                    
                    for (let i = 0; i < binaryData.length; i++) {
                        uint8Array[i] = binaryData.charCodeAt(i);
                    }
                    
                    const blob = new Blob([arrayBuffer], { type: mimeType });
                    const file = new File([blob], `urbanivore-${Date.now()}.png`, { type: mimeType });
                    
                    // Utiliser l'API uSPOT avec authentification NIP-42
                    const result = await uploadToUSPOT(file, publicKey);
                    
                    // Construire l'URL IPFS
                    const ipfsUrl = `${upassportUrl.replace('54321', '8080')}/ipfs/${result.new_cid}/${file.name}`;
                    
                    resolve({
                        uploadedFileURL: ipfsUrl,
                        nip94Tags: [
                            ['url', ipfsUrl],
                            ['m', mimeType],
                            ['x', result.new_cid]
                        ],
                        fileSize: file.size
                    });
                    
                } catch (error) {
                    reject(`Erreur upload uSPOT: ${error.message}`);
                }
            });
        }

        async function refreshMessages() {
            if (!publicKey || !pool) return;
            
            try {
                updateStatus('R√©cup√©ration des messages...', 'info');
                
                const events = await pool.list(DEFAULT_RELAYS, [
                    { kinds: [1], authors: [publicKey], limit: 20 }
                ]);
                
                const messagesContainer = document.getElementById('messages-container');
                messagesContainer.innerHTML = '';
                
                if (events.length === 0) {
                    messagesContainer.innerHTML = '<p>Aucun message trouv√©</p>';
                    return;
                }
                
                // Trier par date (plus r√©cent en premier)
                events.sort((a, b) => b.created_at - a.created_at);
                
                events.forEach(event => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'message-item';
                    
                    const header = document.createElement('div');
                    header.className = 'message-header';
                    header.innerHTML = `
                        <span>${new Date(event.created_at * 1000).toLocaleString()}</span>
                        <span>ID: ${event.id.slice(0, 8)}...</span>
                    `;
                    
                    const content = document.createElement('div');
                    content.className = 'message-content';
                    
                    // Traiter le contenu (texte + images)
                    const lines = event.content.split('\n');
                    lines.forEach((line, i) => {
                        const trimmed = line.trim();
                        if (/\.(jpg|jpeg|png|gif|webp)$/i.test(trimmed)) {
                            const img = document.createElement('img');
                            img.src = trimmed;
                            content.appendChild(img);
                        } else if (/^https?:\/\//.test(trimmed)) {
                            const link = document.createElement('a');
                            link.href = trimmed;
                            link.target = '_blank';
                            link.textContent = trimmed;
                            content.appendChild(link);
                        } else {
                            content.appendChild(document.createTextNode(line));
                        }
                        if (i < lines.length - 1) content.appendChild(document.createElement('br'));
                    });
                    
                    // Afficher les tags
                    const tags = document.createElement('div');
                    tags.className = 'message-tags';
                    
                    event.tags.forEach(tag => {
                        if (tag[0] === 'type' || tag[0] === 'species' || tag[0] === 'title') {
                            const tagSpan = document.createElement('span');
                            tagSpan.className = 'tag';
                            tagSpan.textContent = `${tag[0]}: ${tag[1]}`;
                            tags.appendChild(tagSpan);
                        }
                    });
                    
                    messageDiv.appendChild(header);
                    messageDiv.appendChild(content);
                    messageDiv.appendChild(tags);
                    messagesContainer.appendChild(messageDiv);
                });
                
                updateStatus(`${events.length} messages r√©cup√©r√©s`, 'success');
                
            } catch (error) {
                log(`Erreur r√©cup√©ration messages: ${error.message}`);
                updateStatus(`Erreur: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>
